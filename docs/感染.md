# 策略路径地图 + 交叉感染审计（现状扫描）

> 仅描述当前实现的真实执行路径与共享触发点，便于后续人工标注与隔离。未做任何代码修改。

## 1) Grid 模式真实执行路径（含基础/进阶风控）
- 入口：`run()` 主循环在 `zigzag_timing_enabled=False` 时走 grid 分支。
- 前置：`get_contract_attributes`→`connect`→初始日志/通知；每日 PnL `_maybe_send_daily_pnl`。
- Webhook（仅基础风险）：`_poll_webhook_direction` + `_handle_webhook_stop_tasks`（stop/reverse，fast/slow）。
- 慢速反手：`pending_reverse_state`==`unwinding` 时 `_perform_slow_unwind`。
- 周期性日志/风控：`_log_status_periodically`
  - 缓存/数据：`_get_active_orders_cached`（TTL 2s/6s）、`_get_position_signed_cached`、`_get_bbo_cached`（共享 BBO 文件可选）。
  - 基础风控：`max_position_limit`→stop_new_orders + reduce-only 纠偏。
  - 进阶风控：position vs active_close mismatch 自动 reduce-only 补/撤单；冗余度计算（stop_new_orders gate）；release_timeout_minutes/basic_release_timeout_minutes 触发减仓；webhook_sl 轮询。
  - 状态：`stop_new_orders`、`redundancy_insufficient_since`、`basic_full_since`、`_orders_cache/_position_cache`、`_equity_cache`。
- 价格/止损/停新：`_check_price_condition`
  - 依赖：`_get_bbo_cached(force=True)`、`_get_last_trade_price_cached(force=True)`。
  - 动态 SL：`dynamic_stop_price` 命中则 `_execute_stop_loss`（撤单→reduce-only/market 平仓→重置动态 SL）。
  - stop_price / pause_price：触发 graceful_shutdown 或暂停。
  - ZigZag 自动反手：仅当 `enable_zigzag && enable_auto_reverse`，会在 grid 流程内触发 `_handle_reverse_signal`。
- 下单主路径：等待 `_calculate_wait_time` → `_meet_grid_step_condition` → `_place_and_monitor_open_order`
  - 下单前校验：`stop_new_orders`/`webhook_block_trading`、`_get_bbo_cached(force=True)`、`_get_last_trade_price_cached(force=True)`、动态 SL 边界。
  - 下单：`place_open_order` → `_handle_order_result`（post-only/撤单重下、TP 下单 `_place_take_profit_order`）。
  - 状态：`current_direction/config.direction`、`dynamic_stop_price` 可能更新；`last_open_order_time`、`_orders_cache/_position_cache` 失效。
- 自愈：`_log_status_periodically` 的 position vs close mismatch、stop_new_orders release、reduce-only 纠偏；`_close_all_positions_and_orders`/`graceful_shutdown` 触发的全撤全平。
- 共享/持久化依赖：共享 BBO 文件（`SHARED_BBO_FILE` key=`exchange:contract_id`）、`_AsyncCache` TTL；Webhook 基础方向文件；通知（Lark/Telegram）；环境变量风控阈值。

## 2) ZigZag Timing 模式真实执行路径
- 入口：`run()` 主循环首行判断 `zigzag_timing_enabled=True`，直接 `await _handle_zigzag_timing_cycle(); sleep(0.5); continue`，不走 grid 的 `_log_status_periodically`。
- 前置：启动时 `_initialize_pivots_from_store`、`_backfill_recent_pivot_prices`、`_sync_direction_lock(force=True)`。
- 周期循环 `_handle_zigzag_timing_cycle`：
  - 同步外部 pivot：`_sync_external_pivots` → `_build_pivot_points` → `_handle_pivot_event`（更新 confirmed high/low、动态 SL、慢速反手跟进、通知）。
  - 行情：`_get_bbo_for_zigzag`（强制/节流，仍用共享 BBO 文件）、`_get_last_trade_price_cached`。
  - 状态对齐：`_sync_direction_lock`（direction_lock=持仓方向/None）、`_realign_direction_state`（残余仓 reduce-only、flat 时依据突破重置意向方向）。
  - 止损：`dynamic_stop_price` 或 `zigzag_stop_price` 命中 → `_execute_zigzag_stop`（撤 TP、post-only reduce-only 平仓、清理 pending_entry/stop）。
  - 突破信号：last_confirmed_high/low ± break_buffer_ticks → 设置 `pending_entry`/`pending_break_price`，清空 pending_orders。
  - pending_entry 处理：`_process_pending_zigzag_entry`
    - 先 `_flatten_opposite`（撤反向挂单，post-only reduce-only 平反向仓）。
    - 风控开仓量：`_calc_qty_by_risk_zigzag`（risk_pct、stop distance、equity snapshot、min_order_size）。
    - 进场：overshoot=false → `_post_only_entry_batch` 逐笔挂单等待 → `_finalize_pending_entry`（方向锁、stop_price=buffer、动态 SL、TP=RR 1:2 50%）；overshoot=true → 静态破位价挂单。
  - 慢速反手：`pending_reverse_state`/`pending_reverse_direction` 由 `_handle_reverse_signal`（zigzag auto reverse 关闭后通常不触发）或 webhook stop 复用。
- 共享/状态：
  - 关键状态：`direction_lock`、`pending_entry`、`pending_break_price`、`pending_entry_static_mode`、`_pending_entry_order_ids`、`zigzag_stop_price`、`zigzag_entry_price`、`dynamic_stop_price`、`zigzag_tp_order_id/qty`、`pending_reverse_state/direction`。
  - 依赖：`zigzag_pivot_file`（外部 webhook 写入）、`WEBHOOK_BASIC_DIRECTION_FILE`（仅 _poll_webhook_direction 时用）、共享 BBO 文件。
  - 风控：动态 SL/冗余检查在 `_refresh_stop_loss` → `_run_redundancy_check`；stop_new_orders 仍是全局标志。

## 3) 共享钩子 / 共享状态清单（跨策略触达）
- `stop_new_orders` 及其计时：`_set_stop_new_orders` 在 grid 风控、自愈、webhook stop、zigzag stop/反手/恢复中都可能改动。
- `dynamic_stop_price/direction`：grid 和 zigzag 共用同一字段（zigzag 强制开启动态 SL，会刷新并触发冗余检查）。
- 冗余/风险检查：`_run_redundancy_check`（由 `_refresh_stop_loss` 调用；zigzag 频繁触发）。
- 缓存/行情：`_AsyncCache` 键以 contract_id 为粒度（未含 strategy）；共享 BBO 文件键为 `exchange:contract_id`（未含 strategy）。
- 挂单/仓位缓存：`_get_active_orders_cached`/`_get_position_signed_cached` 共享相同键，zigzag 调整 TTL 影响 grid 切换后的节奏。
- Webhook stop/反手：`webhook_stop_mode`、`webhook_block_trading` 全局；可能在任意模式下阻塞开仓。
- 全撤/全平：`_cancel_all_orders_safely`、`_close_all_positions_and_orders`、`graceful_shutdown`。
- 通知/日志：`_notify_error_once`、`send_notification`、`_maybe_send_daily_pnl`。
- 方向字段：`config.direction` / `current_direction` / `direction_lock`（zigzag用锁，grid用 current_direction，切换可能残留）。

## 4) 交叉感染候选点（按优先级）
- 必须隔离（否则方向/下单语义可能错误）
  - `stop_new_orders` 全局共享：zigzag 的冗余检查或 webhook stop 可阻塞 grid；grid 的基础风险满仓可阻塞 zigzag。
  - `dynamic_stop_price/direction` 共用：zigzag 刷新动态 SL 会作用于 grid；grid 切换时可能沿用 zigzag 的 stop。
  - `_run_redundancy_check` 在 zigzag 中触发 stop_new_orders/减仓，影响 grid。
  - 方向字段共用：`config.direction`/`current_direction` 被 zigzag `_set_direction_all` 频繁写入，切回 grid 时继承。
  - 行情缓存/共享 BBO 键未含 strategy：策略切换时可能读到旧模式写入的 BBO 时间戳或缓存。
- 应当隔离（语义/频率/性能可能不合理）
  - `webhook_stop_mode/webhook_block_trading` 全局：grid/webhook stop 后阻塞 zigzag；缺少按策略路由。
  - `_get_active_orders_cached` TTL 受 zigzag 状态影响（pending_entry 等）；切换到 grid 后可能沿用较短 TTL。
  - `max_fast_close_qty`、reduce-only 自愈逻辑在 `_log_status_periodically` 与 zigzag stop/反手共用，可能对 zigzag 特定挂单策略不合理。
  - `_maybe_send_daily_pnl`/通知节奏共享，可能在停用通知的策略下仍受另一策略影响环境变量。
- 可暂缓
  - `_equity_cache` / `_balance_snapshot` 共用同一键（account 粒度），策略切换时影响冗余/风险计算节奏。
  - `_orders_cache` / `_position_cache` 共用，切换后短时可能读到旧模式残留但影响较小（TTL 100s）。

## 5) 隔离建议（设计层面）
- Key/存储隔离：缓存键、共享 BBO、持久化状态统一加入 `account_id + symbol + strategy_name`，并在策略切换时强制失效。
- 状态显式化：将 `stop_new_orders`、`dynamic_stop_price/direction`、冗余计数器等放入策略上下文；Core 只持“真相”（实时持仓/挂单/行情）。
- 风控路由：`_run_redundancy_check`、`_log_status_periodically`、webhook stop 应按策略实例路由；避免策略 A 的风控直接修改策略 B 的 stop_new_orders。
- 策略切换对账：切换时仅读取 Core 真相（持仓/挂单/新鲜度/风控 evaluate 结果），不读取其他策略的私有锁/pending；对账完后清空通用缓存。
- 对拍可验证：保持旧 `trading_bot.py` 行为不变；新架构在 parity 模式下仅应用 L1 热更新，L2/L3 只解析不落地，确保日志对拍；通过结构化日志（strategy/account/decision/price/qty/reason）对比决策一致性。
